{% extends "base.html" %} {% block title %}Dashboard - Investment Tracker{%
endblock %} {% block content %}
<div class="container-fluid">
  <h1 class="mb-4">
    <i class="bi bi-speedometer2"></i> Dashboard de Inversiones
  </h1>

  <!-- Portfolio Summary Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card text-white bg-primary">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 opacity-75">Total Invertido</h6>
          <h3 class="card-title mb-0">
            {{ portfolio.total_invested|currency }}
          </h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-success">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 opacity-75">Valor Actual de Mercado</h6>
          <h3 class="card-title mb-0">
            {{ portfolio.current_market_value|currency }}
          </h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div
        class="card text-white {% if portfolio.today_gain >= 0 %}bg-info{% else %}bg-warning{% endif %}"
      >
        <div class="card-body">
          <h6 class="card-subtitle mb-2 opacity-75">Ganancia Hoy</h6>
          <h3 class="card-title mb-0">
            {{ portfolio.today_gain|currency }} {% if portfolio.today_gain >= 0
            %}
            <i class="bi bi-arrow-up"></i>
            {% else %}
            <i class="bi bi-arrow-down"></i>
            {% endif %}
          </h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div
        class="card text-white {% if portfolio.net_return >= 0 %}bg-success{% else %}bg-danger{% endif %}"
      >
        <div class="card-body">
          <h6 class="card-subtitle mb-2 opacity-75">Retorno Neto (Real)</h6>
          <h3 class="card-title mb-0">
            {{ portfolio.net_return|currency }}
            <small class="fs-6"
              >({{ portfolio.net_return_percentage|percentage }})</small
            >
          </h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Instrument Button -->
  <div class="mb-4">
    <button
      class="btn btn-primary"
      data-bs-toggle="modal"
      data-bs-target="#addInstrumentModal"
    >
      <i class="bi bi-plus-circle"></i> Agregar Instrumento
    </button>
  </div>

  <!-- Instruments Table -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="bi bi-wallet2"></i> Mis Instrumentos</h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Símbolo</th>
              <th>Tipo</th>
              <th class="text-end">Cantidad</th>
              <th class="text-end">Precio Compra</th>
              <th class="text-end">Precio Actual</th>
              <th class="text-end">Costo Total</th>
              <th class="text-end">Valor Actual</th>
              <th class="text-end">Ganancia Mercado</th>
              <th class="text-end">Ganancia Hoy</th>
              <th class="text-end">Retorno Neto</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% if instruments %} {% for inst in instruments %}
            <tr>
              <td><strong>{{ inst.symbol }}</strong></td>
              <td>
                <span
                  class="badge {% if inst.type == 'stock' %}bg-primary {% elif inst.type == 'etf' %}bg-success {% else %}bg-warning{% endif %}"
                >
                  {{ inst.type|upper }}
                </span>
              </td>
              <td class="text-end">{{ inst.quantity|number(12) }}</td>
              <td class="text-end">
                {{ inst.average_purchase_price|currency }}
              </td>
              <td class="text-end">{{ inst.current_price|currency }}</td>
              <td class="text-end">{{ inst.total_cost|currency }}</td>
              <td class="text-end">{{ inst.current_value|currency }}</td>
              <td
                class="text-end {% if inst.market_gain >= 0 %}text-success{% else %}text-danger{% endif %}"
              >
                {{ inst.market_gain|currency }}
              </td>
              <td
                class="text-end {% if inst.today_gain >= 0 %}text-success{% else %}text-danger{% endif %}"
              >
                {{ inst.today_gain|currency }}
              </td>
              <td
                class="text-end {% if inst.net_return >= 0 %}text-success{% else %}text-danger{% endif %}"
              >
                {{ inst.net_return|currency }}
                <br />
                <small>({{ inst.net_return_percentage|percentage }})</small>
              </td>
              <td class="text-center">
                <a
                  href="{{ url_for('main.register_transaction', instrument_id=inst.instrument_id) }}"
                  class="btn btn-sm btn-outline-primary"
                  title="Registrar Movimiento"
                >
                  <i class="bi bi-pencil-square"></i>
                </a>
                <button
                  class="btn btn-sm btn-outline-danger"
                  onclick="deleteInstrument({{ inst.instrument_id }}, '{{ inst.symbol }}')"
                  title="Eliminar"
                >
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
            {% endfor %} {% else %}
            <tr>
              <td colspan="11" class="text-center py-5 text-muted">
                <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                No hay instrumentos en el portafolio. Agrega tu primer
                instrumento para comenzar.
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  {% if instruments %}
  <div class="row g-4 mb-4">
    <!-- By Type Chart -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0">Distribución por Tipo</h6>
        </div>
        <div class="card-body">
          <canvas id="typeChart"></canvas>
        </div>
      </div>
    </div>

    <!-- By Risk Chart -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0">Distribución por Riesgo</h6>
        </div>
        <div class="card-body">
          <canvas id="riskChart"></canvas>
        </div>
      </div>
    </div>

    <!-- By Instrument Chart -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0">Distribución por Instrumento</h6>
        </div>
        <div class="card-body">
          <canvas id="instrumentChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Add Instrument Modal -->
<div class="modal fade" id="addInstrumentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle"></i> Agregar Instrumento
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <form id="addInstrumentForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="symbol" class="form-label">Símbolo</label>
            <input
              type="text"
              class="form-control"
              id="symbol"
              name="symbol"
              required
              placeholder="Ej: AAPL, BTC"
            />
            <div class="form-text">
              Para criptomonedas no es necesario incluir -USD
            </div>
          </div>
          <div class="mb-3">
            <label for="instrument_type" class="form-label"
              >Tipo de Instrumento</label
            >
            <select
              class="form-select"
              id="instrument_type"
              name="instrument_type"
              required
            >
              <option value="">Seleccione...</option>
              <option value="stock">Stock (Acción)</option>
              <option value="etf">ETF</option>
              <option value="crypto">Criptomoneda</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i> Agregar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script>
  // Add Instrument Form Handler
  document.getElementById('addInstrumentForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const formData = new FormData(this);
      const submitBtn = this.querySelector('button[type="submit"]');
      submitBtn.disabled = true;

      try {
          const response = await fetch('{{ url_for("main.add_instrument") }}', {
              method: 'POST',
              body: formData
          });

          const data = await response.json();

          if (data.success) {
              alert(data.message);
              location.reload();
          } else {
              alert(data.message);
          }
      } catch (error) {
          alert('Error al agregar el instrumento');
      } finally {
          submitBtn.disabled = false;
      }
  });

  // Delete Instrument Function
  async function deleteInstrument(instrumentId, symbol) {
      if (!confirm(`¿Está seguro de eliminar ${symbol}? Esta acción no se puede deshacer.`)) {
          return;
      }

      try {
          const response = await fetch(`/delete-instrument/${instrumentId}`, {
              method: 'POST'
          });

          const data = await response.json();

          if (data.success) {
              alert(data.message);
              location.reload();
          } else {
              alert(data.message);
          }
      } catch (error) {
          alert('Error al eliminar el instrumento');
      }
  }

  // Charts
  {% if instruments %}
  const distribution = {{ distribution|tojson }};

  // Helper function to create doughnut chart
  function createDoughnutChart(canvasId, data, title) {
      const ctx = document.getElementById(canvasId).getContext('2d');

      new Chart(ctx, {
          type: 'doughnut',
          data: {
              labels: data.map(d => d.label),
              datasets: [{
                  data: data.map(d => d.percentage),
                  backgroundColor: [
                      '#0d6efd', '#198754', '#ffc107', '#dc3545',
                      '#6f42c1', '#fd7e14', '#20c997', '#6c757d'
                  ]
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                  legend: {
                      position: 'bottom'
                  },
                  tooltip: {
                      callbacks: {
                          label: function(context) {
                              const label = context.label || '';
                              const value = data[context.dataIndex].value;
                              const percentage = context.parsed;
                              return `${label}: $${value.toFixed(2)} (${percentage.toFixed(2)}%)`;
                          }
                      }
                  }
              }
          }
      });
  }

  // Create charts
  if (distribution.by_type && distribution.by_type.length > 0) {
      createDoughnutChart('typeChart', distribution.by_type, 'Por Tipo');
  }

  if (distribution.by_risk && distribution.by_risk.length > 0) {
      createDoughnutChart('riskChart', distribution.by_risk, 'Por Riesgo');
  }

  if (distribution.by_instrument && distribution.by_instrument.length > 0) {
      createDoughnutChart('instrumentChart', distribution.by_instrument, 'Por Instrumento');
  }
  {% endif %}
</script>
{% endblock %}
