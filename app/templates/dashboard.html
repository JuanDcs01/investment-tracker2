{% extends "base.html" %} {% block title %}Dashboard - Investment Tracker{%
endblock %} {% block content %}
<div class="container-fluid">
  <h2 class="mb-4">
    <i class="bi bi-speedometer2"></i> Rendimiento de Inversiones
  </h2>

  <div class="row g-3 mb-4">
    <div class="col-xl">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">
            <i class="bi bi-bar-chart-fill"></i> Inversión Actual
          </h6>
          <h3 class="card-title mb-0">
            {{ portfolio.current_investment|currency }}
          </h3>
          <small class="text-muted">En posiciones abiertas</small>
        </div>
      </div>
    </div>

    <div class="col-xl">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">
            <i class="bi bi-bank"></i> Valor Actual de Mercado
          </h6>
          <div class="d-flex align-items-baseline gap-2">
            <h3 class="card-title mb-0">
              {{ portfolio.current_market_value|currency }}
            </h3>
            <small class="fs-6"
              >RD{{ portfolio.current_market_value_dop|currency }}</small
            >
          </div>
          <small class="text-muted">Valor de tus posiciones</small>
        </div>
      </div>
    </div>

    <div class="col-xl">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">
            <i class="bi bi-hourglass"></i> Ganancia no Realizada
          </h6>
          <h3
            class="card-title mb-0 {% if portfolio.unrealized_gain >= 0 %}text-success{% else %}text-danger{% endif %}"
          >
            {{ portfolio.unrealized_gain|currency }}
            <small class="fs-6"
              >({{ portfolio.unrealized_gain_percentage|percentage }})</small
            >
          </h3>
          <small class="text-muted">Posición actual</small>
        </div>
      </div>
    </div>

    <div class="col-xl">
      <div class="card h-100 border-primary">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">
            <i class="bi bi-cash-coin"></i> Ganancia Realizada
          </h6>
          <h3
            class="card-title mb-0 {% if portfolio.realized_gain >= 0 %}text-success{% else %}text-danger{% endif %}"
          >
            {{ portfolio.realized_gain|currency }}
            <small class="fs-6"
              >({{ portfolio.realized_gain_percentage|percentage }})</small
            >
          </h3>
          <small class="text-muted">De ventas pasadas</small>
        </div>
      </div>
    </div>

    <div class="col-xl">
      <div class="card h-100 border-success">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">
            <i class="bi bi-trophy"></i> Ganancia Total
          </h6>
          <h3
            class="card-title mb-0 {% if portfolio.total_gain >= 0 %}text-success{% else %}text-danger{% endif %}"
          >
            {{ portfolio.total_gain|currency }}
            <small class="fs-6"
              >({{ portfolio.total_gain_percentage|percentage }})</small
            >
          </h3>
          <small class="text-muted">Realizada + No Realizada</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Cartera -->
  <div class="card mb-4">
    <div
      class="card-header d-flex justify-content-between align-items-center flex-wrap gap-3"
    >
      <h6 class="m-1">Billetera: {{ wallet.balance|currency }}</h6>
      <div class="d-flex gap-2">
        <button
          class="btn btn-primary text-nowrap"
          data-bs-toggle="modal"
          data-bs-target="#editwallet"
        >
          <i class="bi bi-pencil"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Instruments Table -->
  <div class="card mb-4">
    <div
      class="card-header d-flex justify-content-between align-items-center flex-wrap gap-3"
    >
      <h5 class="mb-0"><i class="bi bi-wallet2"></i> Mis Instrumentos</h5>

      <div class="d-flex gap-2">
        <button class="btn btn-primary" onclick="refreshPrices()">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
        <button
          class="btn btn-primary text-nowrap"
          data-bs-toggle="modal"
          data-bs-target="#addInstrumentModal"
        >
          <i class="bi bi-plus"></i> Agregar Instrumento
        </button>
      </div>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Símbolo</th>
              <th class="solo-desktop">Tipo</th>
              <th class="text-end solo-desktop">Cantidad</th>
              <th class="text-end">Precio Actual</th>
              <th class="text-end">Ultima apertura</th>
              <th class="text-end solo-desktop">Inversión Actual</th>
              <th class="text-end">Valor Mercado</th>
              <th class="text-end">G. No Realizada</th>
              <th class="text-end">G. Realizada</th>
              <th class="text-end">G. Total</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% if instruments %} {% for inst in instruments %}
            <tr>
              <td><strong>{{ inst.symbol }}</strong></td>
              <td class="solo-desktop">
                <span
                  class="badge {% if inst.type == 'stock' %}bg-primary {% elif inst.type == 'etf' %}bg-success {% else %}bg-warning{% endif %}"
                >
                  {{ inst.type|upper }}
                </span>
              </td>
              <td class="text-end solo-desktop">
                {{ inst.current_quantity|number(4) }}
              </td>
              <td class="text-end">{{ inst.current_price|currency }}</td>

              <!-- Ultima apertura -->
              <td
                class="text-end {% if inst.change >= 0 %}text-success{% else %}text-danger{% endif %}"
              >
                {{ inst.change|currency }}
                <br />
                <small>({{ inst.change_percentage|percentage }})</small>
              </td>

              <!-- Inversión Actual -->
              <td class="text-end solo-desktop">
                {{ inst.current_investment|currency }}
              </td>

              <!-- Valor Mercado -->
              <td class="text-end">{{ inst.current_value|currency }}</td>

              <!-- Ganancia No Realizada -->
              <td
                class="text-end {% if inst.unrealized_gain >= 0 %}text-success{% else %}text-danger{% endif %}"
              >
                {{ inst.unrealized_gain|currency }}
                <br />
                <small
                  >({{ inst.unrealized_gain_percentage|percentage }})</small
                >
              </td>

              <!-- Ganancia Realizada -->
              <td
                class="text-end {% if inst.realized_gain >= 0 %}text-success{% else %}text-danger{% endif %}"
              >
                {{ inst.realized_gain|currency }}
                <br />
                <small>({{ inst.realized_gain_percentage|percentage }})</small>
              </td>

              <!-- Ganancia Total (AGREGADA DE VUELTA) -->
              <td
                class="text-end {% if inst.total_gain >= 0 %}text-success{% else %}text-danger{% endif %}"
              >
                {{ inst.total_gain|currency }}
                <br />
                <small>({{ inst.total_gain_percentage|percentage }})</small>
              </td>

              <td class="text-center">
                <!-- <a
                  class="btn btn-sm btn-outline-secondary"
                  href="https://www.google.com"
                  title="Eliminar"
                >
                  <i class="bi bi-graph-up"></i>
                </a> -->
                <a
                  href="{{ url_for('main.register_transaction', instrument_id=inst.instrument_id) }}"
                  class="btn btn-sm btn-outline-primary"
                  title="Registrar Movimiento"
                >
                  <i class="bi bi-plus"></i>
                </a>
                <button
                  class="btn btn-sm btn-outline-danger"
                  onclick="deleteInstrument({{ inst.instrument_id }}, '{{ inst.symbol }}')"
                  title="Eliminar"
                >
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
            {% endfor %} {% else %}
            <tr>
              <td colspan="10" class="text-center py-5 text-muted">
                <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                No hay instrumentos en el portafolio. Agrega tu primer
                instrumento para comenzar.
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  {% if instruments %}
  <h2 class="mb-4">
    <i class="bi bi-pie-chart"></i> Distribución del Portafolio
  </h2>

  <div class="row g-4 mb-4">
    <!-- By Type Chart -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0">Distribución por Tipo</h6>
        </div>
        <div
          class="card-body d-flex justify-content-center"
          style="position: relative; height: 350px"
        >
          <canvas id="typeChart"></canvas>
        </div>
      </div>
    </div>

    <!-- By Risk Chart -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0">Distribución por Riesgo</h6>
        </div>
        <div
          class="card-body d-flex justify-content-center"
          style="position: relative; height: 350px"
        >
          <canvas id="riskChart"></canvas>
        </div>
      </div>
    </div>

    <!-- By Instrument Chart -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0">Distribución por Instrumento</h6>
        </div>
        <div
          class="card-body d-flex justify-content-center"
          style="position: relative; height: 350px"
        >
          <canvas id="instrumentChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Add Instrument Modal -->
<div class="modal fade" id="addInstrumentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle"></i> Agregar Instrumento
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <form id="addInstrumentForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="instrument_type" class="form-label"
              >Tipo de Instrumento</label
            >
            <select
              class="form-select"
              id="instrument_type"
              name="instrument_type"
              required
            >
              <option value="">Seleccione...</option>
              <option value="stock">Stock (Acción)</option>
              <option value="etf">ETF</option>
              <option value="crypto">Criptomoneda</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="symbol" class="form-label">Símbolo</label>
            <input
              type="text"
              class="form-control"
              id="symbol"
              name="symbol"
              required
              placeholder="Ej: AAPL, BTC"
            />
            <div class="form-text">
              Para criptomonedas no es necesario incluir -USD
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i> Agregar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- editar wallet -->
<div class="modal fade" id="editwallet" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil"></i> Editar Cartera</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <form id="editWalletForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="quantity" class="form-label"
              >Billetera actual: {{ wallet.balance|currency }}</label
            >
            <input
              type="number"
              step="0.01"
              class="form-control"
              id="balance"
              name="balance"
              placeholder="Nuevo saldo total"
            />
          </div>
          <div class="mb-3">
            <label for="commissions" class="form-label"
              >Comisiones actuales: {{ wallet.commissions|currency }}</label
            >
            <input
              type="number"
              step="0.01"
              class="form-control"
              id="commissions"
              name="commissions"
              placeholder="Total de comisiones"
            />
          </div>
          <div class="mb-3">
            <label for="dividend" class="form-label"
              >Dividendos recibidos: {{ wallet.dividend|currency }}</label
            >
            <input
              type="number"
              step="0.01"
              class="form-control"
              id="dividend"
              name="dividend"
              placeholder="Total de dividendos recibidos"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i> Guardar Cambios
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script>
            // Add Instrument Form Handler
      document.getElementById('addInstrumentForm').addEventListener('submit', async function(e) {
          e.preventDefault();

          const formData = new FormData(this);
          const submitBtn = this.querySelector('button[type="submit"]');
          submitBtn.disabled = true;

          try {
              const response = await fetch('{{ url_for("main.add_instrument") }}', {
                  method: 'POST',
                  body: formData,
                  headers: {
                      'X-CSRFToken': '{{ csrf_token() }}'
                  }
              });

              const data = await response.json();

              if (data.success) {
                  // REEMPLAZO: Alerta de éxito
                  Swal.fire({
                      title: 'Logrado',
                      text: data.message,
                       width: '400px',
                      confirmButtonColor: '#0d6efd'
                  }).then(() => {
                      location.reload();
                  });
              } else {
                  // REEMPLAZO: Alerta de error (ej. "instrumento ya existe")
                  Swal.fire({
                      title: 'Atención',
                      text: data.message,
                      width: '400px',
                      confirmButtonColor: '#0d6efd'
                  });
              }
          } catch (error) {
              // REEMPLAZO: Error de conexión o servidor
              Swal.fire({
                  title: 'Error',
                  text: 'Hubo un problema al procesar la solicitud.',
                  width: '400px',
                  confirmButtonColor: '#0d6efd'
              });
          } finally {
              submitBtn.disabled = false;
          }
      });

            // Manejador para Editar Cartera (Wallet)
            document.getElementById('editWalletForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const formData = new FormData(this);
      const submitBtn = this.querySelector('button[type="submit"]');
      submitBtn.disabled = true;

      try {
          const response = await fetch('{{ url_for("main.update_wallet") }}', {
              method: 'POST',
              body: formData,
              headers: {
                  'X-CSRFToken': '{{ csrf_token() }}'
              }
          });

          const data = await response.json();

          if (data.success) {
              // Éxito: Sin icono, azul Bootstrap, 400px
              await Swal.fire({
                  title: 'Actualizado',
                  text: data.message,
                  confirmButtonColor: '#0d6efd',
                  width: '400px'
              });
              location.reload();
          } else {
              // Error de validación
              Swal.fire({
                  title: 'Atención',
                  text: data.message,
                  confirmButtonColor: '#0d6efd',
                  width: '400px'
              });
          }
      } catch (error) {
          console.error(error);
          // Error de servidor/red
          Swal.fire({
              title: 'Error',
              text: 'Error al actualizar la billetera',
              confirmButtonColor: '#0d6efd',
              width: '400px'
          });
      } finally {
          submitBtn.disabled = false;
      }
  });

            // Delete Instrument Function
    async function deleteInstrument(instrumentId, symbol) {
        // Reemplazamos el confirm() nativo por SweetAlert2
        const result = await Swal.fire({
            title: 'Confirmar eliminación',
            text: `¿Está seguro de eliminar ${symbol}? Esta acción no se puede deshacer.`,
            showCancelButton: true,
            confirmButtonColor: '#0d6efd',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Eliminar',
            cancelButtonText: 'Cancelar',
            width: '400px'
            // icon: 'warning' -> Eliminado según tu petición
        });

        if (result.isConfirmed) {
            try {
                const response = await fetch(`/delete-instrument/${instrumentId}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    await Swal.fire({
                        title: 'Eliminado',
                        text: data.message,
                        confirmButtonColor: '#0d6efd',
                        width: '400px'
                    });
                    location.reload();
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: data.message,
                        confirmButtonColor: '#0d6efd',
                        width: '400px'
                    });
                }
            } catch (error) {
                Swal.fire({
                    title: 'Error',
                    text: 'Error al eliminar el instrumento',
                    confirmButtonColor: '#0d6efd',
                    width: '400px'
                });
            }
        }
    }

    async function refreshPrices() {
        try {
            const response = await fetch('/api/refresh-prices', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            });

            const data = await response.json();

            if (data.success) {
                location.reload();
            } else {
                Swal.fire({
                    title: 'Error',
                    text: 'Error al actualizar precios',
                    confirmButtonColor: '#0d6efd',
                    width: '400px',
                });
            }
        } catch (error) {
            Swal.fire({
                title: 'Error',
                text: 'Error al actualizar precios',
                confirmButtonColor: '#0d6efd',
                width: '400px'
            });
        }
    }

            // Charts
            {% if instruments %}
            const distribution = {{ distribution|tojson | safe}};

            // Helper function to create doughnut chart
          function createDoughnutChart(canvasId, data, title) {
              const ctx = document.getElementById(canvasId).getContext('2d');
              const total = data.reduce((sum, item) => sum + Number(item.value || 0), 0);

              new Chart(ctx, {
                  type: 'doughnut',
                  data: {
                      labels: data.map(d => d.label),
                      datasets: [{
                          data: data.map(d => d.value),
                          backgroundColor: [
                              '#A2D2FF', '#B9FBC0', '#FEFAE0', '#FFCFD2',
                              '#E1DBFF', '#FDE4CF', '#CFFAF1', '#F1F1F1'
                          ],
                          borderWidth: 1,
                          borderColor: '#ffffff'
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: true,
                      plugins: {
                          legend: {
                              position: 'bottom'
                          },
                          tooltip: {
                              callbacks: {
                                  label: function(context) {
                                      const label = context.label || '';
                                      const value = context.parsed;
                                      const percentage = ((value / total) * 100).toFixed(2);
                                      console.log('Tooltip data:', { value, total });
                                      return `${label}: $${value.toLocaleString()} (${percentage}%)`;
                                  }
                              }
                          },
                      datalabels: {
                          color: '#000',
                          font: {
                              weight: 'bold',
                              size: 11
                          },
                          formatter: function(value, context) {
                              const percentage = ((value / total) * 100).toFixed(1);
                              if (percentage > 5) {
                                  return percentage + '%\n$' + value.toLocaleString('en-US', {maximumFractionDigits: 0});
                              }
                              return '';
                          },
                          anchor: 'center',
                          align: 'center'
                      }
                      }
                  },
                  plugins: [ChartDataLabels]
              });
          }

            if (distribution.by_instrument) {
                distribution.by_instrument.push({
                    label: 'Billetera (Cash)',
                    value: {{ wallet.balance|float }} // Convertimos el Decimal a float para JS
                });
            }

            // Create charts
            if (distribution.by_type && distribution.by_type.length > 0) {
                createDoughnutChart('typeChart', distribution.by_type, 'Por Tipo');
            }

            if (distribution.by_risk && distribution.by_risk.length > 0) {
                createDoughnutChart('riskChart', distribution.by_risk, 'Por Riesgo');
            }

            if (distribution.by_instrument && distribution.by_instrument.length > 0) {
                createDoughnutChart('instrumentChart', distribution.by_instrument, 'Por Instrumento');
            }
            {% endif %}
</script>
{% endblock %}
